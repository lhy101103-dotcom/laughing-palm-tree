<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>温馨弹窗 v3.1编辑你的暖心话语 </title>
    <style>
        /* --- 基础样式 --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: background-color 0.5s;
        }

        /* --- 主题配色 --- */
        body { background-color: #f4f4f9; }
        body.theme-warm { background-color: #fff8e1; }
        body.theme-cool { background-color: #e3f2fd; }
        body.theme-dark { background-color: #333; }
        body.theme-green { background-color: #e8f5e9; }

        /* --- 卡片通用样式 --- */
        .floating-card {
            position: absolute; z-index: 1;
            animation: fadeInOut 4s ease-in-out forwards; 
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 3px solid #ddd; 
        }

        /* --- 话语卡片样式 --- */
        .message-card {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.95);
            white-space: nowrap;
        }

        /* --- 图片卡片样式 --- */
        .image-card {
            padding: 0;
            background: #fff;
            max-width: 250px;
            max-height: 250px;
            overflow: hidden;
        }
        .image-card img {
            display: block; width: 100%; height: 100%;
            max-width: 250px; max-height: 250px;
            object-fit: cover;
            border-radius: 6px;
        }

        /* --- 主题卡片颜色 (同步边框) --- */
        body .message-card { border-color: #ddd; }
        body .image-card { border-color: #ccc; }
        body.theme-warm .message-card { background: #fffbeb; border-color: #ffe57f; color: #6d4c00; }
        body.theme-warm .image-card { border-color: #ffe57f; }
        body.theme-cool .message-card { background: #eef8ff; border-color: #90caf9; color: #0d47a1; }
        body.theme-cool .image-card { border-color: #90caf9; }
        body.theme-dark .message-card { background: #424242; border-color: #616161; color: #eee; }
        body.theme-dark .image-card { border-color: #616161; }
        body.theme-green .message-card { background: #f1f8e9; border-color: #a5d6a7; color: #1b5e20; }
        body.theme-green .image-card { border-color: #a5d6a7; }

        /* 卡片动画 */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: scale(0.8) translateY(20px); }
            25% { opacity: 1; transform: scale(1) translateY(0); }
            75% { opacity: 1; transform: scale(1) translateY(0); }
            100% { opacity: 0; transform: scale(0.9) translateY(-10px); }
        }

        /* --- 控制栏 (悬停样式) --- */
        .controls {
            position: fixed; top: 0; right: 0; padding: 20px;
            z-index: 1000; display: flex; gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .controls:hover,
        .controls.force-visible { opacity: 1; }
        .control-button {
            padding: 10px 18px; font-size: 16px;
            background-color: #fff; color: #333;
            border: 1px solid #ccc; border-radius: 8px;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* --- 菜单面板 --- */
        .menu-panel {
            position: fixed; top: 70px; right: 20px; width: 300px;
            background: #fff; border: 1px solid #ccc;
            border-radius: 8px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            padding: 0 20px 20px 20px;
            z-index: 999; box-sizing: border-box;
            display: none;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .menu-panel.visible { display: block; }
        
        .menu-section {
            margin-top: 20px; padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .menu-section:first-child {
             margin-top: 20px; padding-top: 0; border-top: none;
        }
        .menu-section h3 { margin-top: 0; margin-bottom: 15px; }
        .menu-section.hidden { display: none; } /* 隐藏彩蛋 */

        /* 菜单 - 主题选择 */
        .theme-selector {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 8px; margin-bottom: 20px;
        }
        .theme-button {
            padding: 8px 12px; border: 1px solid #ddd;
            border-radius: 6px; cursor: pointer;
            background: #f9f9f9; font-size: 14px; text-align: center;
        }
        /* 主题按钮点击后的高亮 */
        .theme-button.clicked {
            background: #cce7ff;
            border-color: #007bff;
        }

        /* 菜单 - 设置项 */
        .setting-item {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 12px;
        }
        .setting-item label { font-size: 14px; color: #333; }
        .setting-item input[type="number"],
        .setting-item select {
            width: 90px; padding: 5px 8px; border: 1px solid #ccc;
            border-radius: 4px; font-size: 14px; box-sizing: border-box;
        }
        .setting-note {
            font-size: 12px; color: #666; 
            margin-top: -10px; margin-bottom: 15px;
        }

        /* 菜单 - 话语编辑 */
        #phrases-input {
            width: 100%; height: 150px; box-sizing: border-box; 
            border: 1px solid #ccc; border-radius: 6px;
            padding: 10px; font-size: 14px; line-height: 1.5;
            resize: vertical; 
        }

        /* 菜单 - 按钮 */
        #save-button {
            width: 100%; padding: 12px; font-size: 16px;
            background-color: #007bff; color: white;
            border: none; border-radius: 6px;
            cursor: pointer; margin-top: 15px;
        }
    </style>
</head>
<body>

    <div class="controls">
        <button id="pause-button" class="control-button">暂停</button>
        <button id="menu-button" class="control-button">菜单</button>
    </div>

    <div id="menu-panel" class="menu-panel">
        
        <div class="menu-section">
            <h3>🎨 切换主题</h3>
            <div class="theme-selector">
                <button class="theme-button" data-theme="default">默认</button>
                <button class="theme-button" data-theme="warm">温暖</button>
                <button class="theme-button" data-theme="cool">清凉</button>
                <button class="theme-button" data-theme="dark">深色</button>
                <button class="theme-button" data-theme="green">绿色</button>
            </div>
        </div>

        <div class="menu-section">
            <h3>⚙️ 效果设置</h3>
            <div class="setting-item">
                <label for="speed-input">生成速度 (毫秒)</label>
                <input type="number" id="speed-input" min="100" step="100">
            </div>
            <p class="setting-note">(建议 100-2000 之间，越小越快)</p>
            <div class="setting-item">
                <label for="duration-input">消失时间 (毫秒)</label>
                <input type="number" id="duration-input" min="1000" step="500">
            </div>
            <p class="setting-note">(建议 2000-8000 之间，越长停留越久)</p>
        </div>

        <div class="menu-section">
            <h3>✏️ 编辑温馨话语</h3>
            <p style="font-size: 12px; color: #666; margin-top: 0;">(每行一句)</p>
            <textarea id="phrases-input"></textarea>
        </div>

        <div id="image-settings" class="menu-section hidden">
            <h3>🖼️ 图片设置 <span style="font-size: 12px; color: #007bff;">(已解锁)</span></h3>
            
            <input type="file" id="image-upload" multiple accept="image/*" style="width: 100%; margin-bottom: 10px;">
            <p id="image-status" style="font-size: 14px; color: #333; margin: 5px 0 10px;">已加载 0 / 50 张图片</p>
            <p class="setting-note" style="margin-top: 0; color: #d9534f;">(注意：图片仅在当前会话有效，关闭页面将丢失)</p>

            <div class="setting-item">
                <label for="border-size-input">边框大小 (px)</label>
                <input type="number" id="border-size-input" min="0" max="20" step="1" value="3">
            </div>
             <div class="setting-item">
                <label for="border-style-input">边框样式</label>
                <select id="border-style-input">
                    <option value="solid">实线</option>
                    <option value="dashed">虚线</option>
                    <option value="double">双实线</option>
                    <option value="dotted">点线</option>
                </select>
            </div>
        </div>
        
        <button id="save-button">保存并关闭</button>
    </div>

    <script>
        // --- 状态变量 ---
        let isPaused = false;
        let messageInterval;
        let messages = [
            "你好呀！", "今天也要开心哦！", "你是最棒的！",
            "加油！", "一切都会好起来的", "世界因为你而美好",
            "别忘了休息", "保持微笑 :)"
        ];
        let messageSpawnRate = 700;
        let messageDuration = 3900;
        
        // --- 图片功能变量 ---
        let userImages = [];
        const MAX_IMAGES = 50;
        let imageFeatureUnlocked = false;
        const unlockedThemes = new Set();
        let imageBorderSize = 3;
        let imageBorderStyle = 'solid';
        let imageSpawnChance = 0.3;

        // --- DOM 元素 (已修改) ---
        const controlsContainer = document.querySelector('.controls');
        const pauseButton = document.getElementById('pause-button');
        const menuButton = document.getElementById('menu-button');
        const menuPanel = document.getElementById('menu-panel');
        const phrasesInput = document.getElementById('phrases-input');
        const saveButton = document.getElementById('save-button');
        const themeSelector = document.querySelector('.theme-selector');
        const speedInput = document.getElementById('speed-input');
        const durationInput = document.getElementById('duration-input');
        
        // --- 图片功能 DOM 元素 ---
        const imageSettingsSection = document.getElementById('image-settings');
        const imageUpload = document.getElementById('image-upload');
        const imageStatus = document.getElementById('image-status');
        const borderSizeInput = document.getElementById('border-size-input');
        const borderStyleInput = document.getElementById('border-style-input');
        
        // --- 🔴 已移除 imageSettingsLock 变量 ---

        /**
         * 生成元素的总控函数
         */
        function spawnElement() {
            if (isPaused) { return; }
            const shouldSpawnImage = userImages.length > 0 && Math.random() < imageSpawnChance;
            if (shouldSpawnImage) {
                createImageCard();
            } else {
                createMessageCard();
            }
        }

        /**
         * 创建一个话语卡片
         */
        function createMessageCard() {
            const card = document.createElement('div');
            card.className = 'floating-card message-card';
            const text = messages[Math.floor(Math.random() * messages.length)];
            card.textContent = text;
            setupCardPositionAndAnimation(card);
        }
        
        /**
         * 创建一个图片卡片
         */
        function createImageCard() {
            const card = document.createElement('div');
            card.className = 'floating-card image-card';
            const img = document.createElement('img');
            img.src = userImages[Math.floor(Math.random() * userImages.length)];
            card.appendChild(img);
            card.style.borderWidth = `${imageBorderSize}px`;
            card.style.borderStyle = imageBorderStyle;
            setupCardPositionAndAnimation(card);
        }
        
        /**
         * 设置卡片位置和动画 (通用逻辑)
         */
        function setupCardPositionAndAnimation(cardElement) {
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const x = Math.random() * (viewportWidth - 250) + 20; 
            const y = Math.random() * (viewportHeight - 100) + 20;
            cardElement.style.left = `${x}px`;
            cardElement.style.top = `${y}px`;
            cardElement.style.animationDuration = `${messageDuration / 1000}s`;
            document.body.appendChild(cardElement);
            setTimeout(() => {
                cardElement.remove();
            }, messageDuration);
        }

        /**
         * 启动/停止话语生成
         */
        function startSpawning() {
            stopSpawning(); 
            if (!messageInterval) {
                messageInterval = setInterval(spawnElement, messageSpawnRate);
            }
        }
        function stopSpawning() {
            clearInterval(messageInterval);
            messageInterval = null;
        }

        /**
         * 暂停/开启 按钮事件
         */
        pauseButton.addEventListener('click', () => {
            isPaused = !isPaused;
            if (isPaused) {
                pauseButton.textContent = '开启';
                stopSpawning();
            } else {
                pauseButton.textContent = '暂停';
                startSpawning();
            }
        });

        /**
         * 菜单 按钮事件
         */
        menuButton.addEventListener('click', () => {
            const isVisible = menuPanel.classList.toggle('visible');
            controlsContainer.classList.toggle('force-visible', isVisible);
            if (isVisible) {
                phrasesInput.value = messages.join('\n');
                speedInput.value = messageSpawnRate;
                durationInput.value = messageDuration;
                if (imageFeatureUnlocked) {
                    borderSizeInput.value = imageBorderSize;
                    borderStyleInput.value = imageBorderStyle;
                }
            }
        });

        /**
         * 保存 按钮事件
         */
        saveButton.addEventListener('click', () => {
            const newText = phrasesInput.value;
            const newMessages = newText.split('\n')
                                     .map(line => line.trim()) 
                                     .filter(line => line.length > 0); 
            if (newMessages.length > 0) { messages = newMessages; }
            const newSpeed = parseInt(speedInput.value, 10);
            const newDuration = parseInt(durationInput.value, 10);
            if (newSpeed && newSpeed >= 100) { messageSpawnRate = newSpeed; }
            if (newDuration && newDuration >= 1000) { messageDuration = newDuration; }
            if (imageFeatureUnlocked) {
                imageBorderSize = parseInt(borderSizeInput.value, 10) || 3;
                imageBorderStyle = borderStyleInput.value || 'solid';
            }
            stopSpawning();
            if (!isPaused) { startSpawning(); }
            menuPanel.classList.remove('visible');
            controlsContainer.classList.remove('force-visible');
            alert('设置已保存！');
        });

        /**
         * 解锁图片功能 (已修改)
         */
        function unlockImageFeature() {
            if (imageFeatureUnlocked) return;
            imageFeatureUnlocked = true;
            imageSettingsSection.classList.remove('hidden'); // 只需显示功能区
            
            // 🔴 已移除对 imageSettingsLock 的引用

            borderSizeInput.value = imageBorderSize;
            borderStyleInput.value = imageBorderStyle;
            alert('🎉 隐藏功能解锁！您现在可以添加图片了！');
        }

        /**
         * 处理图片上传
         */
        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files) return;
            for (let i = 0; i < files.length; i++) {
                if (userImages.length >= MAX_IMAGES) {
                    alert(`最多只能添加 ${MAX_IMAGES} 张图片。`);
                    break;
                }
                const file = files[i];
                if (!file.type.startsWith('image/')){ continue; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (userImages.length < MAX_IMAGES) {
                        userImages.push(e.target.result);
                    }
                    updateImageStatus();
                }
                reader.readAsDataURL(file);
            }
            event.target.value = null; 
        }

        function updateImageStatus() {
            imageStatus.textContent = `已加载 ${userImages.length} / ${MAX_IMAGES} 张图片`;
        }

        // --- 事件监听 ---

        /**
         * 主题切换 事件 (彩蛋逻辑)
         */
        themeSelector.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('theme-button')) {
                const theme = target.dataset.theme;
                
                // 1. 应用主题
                document.body.className = document.body.className.replace(/\btheme-[^\s]*/g, '');
                if (theme !== 'default') {
                    document.body.classList.add(`theme-${theme}`);
                }
                
                // 2. 彩蛋逻辑
                if (!imageFeatureUnlocked) {
                    target.classList.add('clicked');
                    unlockedThemes.add(theme);
                    if (unlockedThemes.size === 5) { // 5个主题
                        unlockImageFeature();
                    }
                }
            }
        });
        
        // 监听图片上传
        imageUpload.addEventListener('change', handleImageUpload);

        /**
         * 启动
         */
        document.addEventListener('DOMContentLoaded', () => {
            startSpawning();
        });
    </script>
</body>
</html>

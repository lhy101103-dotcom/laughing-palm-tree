<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¸©é¦¨å¼¹çª— v3.1 </title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            transition: background-color 0.5s;
        }

        /* --- ä¸»é¢˜é…è‰² --- */
        body { background-color: #f4f4f9; }
        body.theme-warm { background-color: #fff8e1; }
        body.theme-cool { background-color: #e3f2fd; }
        body.theme-dark { background-color: #333; }
        body.theme-green { background-color: #e8f5e9; }

        /* --- å¡ç‰‡é€šç”¨æ ·å¼ --- */
        .floating-card {
            position: absolute; z-index: 1;
            animation: fadeInOut 4s ease-in-out forwards; 
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 3px solid #ddd; 
        }

        /* --- è¯è¯­å¡ç‰‡æ ·å¼ --- */
        .message-card {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.95);
            white-space: nowrap;
        }

        /* --- å›¾ç‰‡å¡ç‰‡æ ·å¼ --- */
        .image-card {
            padding: 0;
            background: #fff;
            max-width: 250px;
            max-height: 250px;
            overflow: hidden;
        }
        .image-card img {
            display: block; width: 100%; height: 100%;
            max-width: 250px; max-height: 250px;
            object-fit: cover;
            border-radius: 6px;
        }

        /* --- ä¸»é¢˜å¡ç‰‡é¢œè‰² (åŒæ­¥è¾¹æ¡†) --- */
        body .message-card { border-color: #ddd; }
        body .image-card { border-color: #ccc; }
        body.theme-warm .message-card { background: #fffbeb; border-color: #ffe57f; color: #6d4c00; }
        body.theme-warm .image-card { border-color: #ffe57f; }
        body.theme-cool .message-card { background: #eef8ff; border-color: #90caf9; color: #0d47a1; }
        body.theme-cool .image-card { border-color: #90caf9; }
        body.theme-dark .message-card { background: #424242; border-color: #616161; color: #eee; }
        body.theme-dark .image-card { border-color: #616161; }
        body.theme-green .message-card { background: #f1f8e9; border-color: #a5d6a7; color: #1b5e20; }
        body.theme-green .image-card { border-color: #a5d6a7; }

        /* å¡ç‰‡åŠ¨ç”» */
        @keyframes fadeInOut {
            0% { opacity: 0; transform: scale(0.8) translateY(20px); }
            25% { opacity: 1; transform: scale(1) translateY(0); }
            75% { opacity: 1; transform: scale(1) translateY(0); }
            100% { opacity: 0; transform: scale(0.9) translateY(-10px); }
        }

        /* --- æ§åˆ¶æ  (æ‚¬åœæ ·å¼) --- */
        .controls {
            position: fixed; top: 0; right: 0; padding: 20px;
            z-index: 1000; display: flex; gap: 10px;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .controls:hover,
        .controls.force-visible { opacity: 1; }
        .control-button {
            padding: 10px 18px; font-size: 16px;
            background-color: #fff; color: #333;
            border: 1px solid #ccc; border-radius: 8px;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* --- èœå•é¢æ¿ --- */
        .menu-panel {
            position: fixed; top: 70px; right: 20px; width: 300px;
            background: #fff; border: 1px solid #ccc;
            border-radius: 8px; box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            padding: 0 20px 20px 20px;
            z-index: 999; box-sizing: border-box;
            display: none;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        .menu-panel.visible { display: block; }
        
        .menu-section {
            margin-top: 20px; padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .menu-section:first-child {
             margin-top: 20px; padding-top: 0; border-top: none;
        }
        .menu-section h3 { margin-top: 0; margin-bottom: 15px; }
        .menu-section.hidden { display: none; } /* éšè—å½©è›‹ */

        /* èœå• - ä¸»é¢˜é€‰æ‹© */
        .theme-selector {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 8px; margin-bottom: 20px;
        }
        .theme-button {
            padding: 8px 12px; border: 1px solid #ddd;
            border-radius: 6px; cursor: pointer;
            background: #f9f9f9; font-size: 14px; text-align: center;
        }
        /* ä¸»é¢˜æŒ‰é’®ç‚¹å‡»åçš„é«˜äº® */
        .theme-button.clicked {
            background: #cce7ff;
            border-color: #007bff;
        }

        /* èœå• - è®¾ç½®é¡¹ */
        .setting-item {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 12px;
        }
        .setting-item label { font-size: 14px; color: #333; }
        .setting-item input[type="number"],
        .setting-item select {
            width: 90px; padding: 5px 8px; border: 1px solid #ccc;
            border-radius: 4px; font-size: 14px; box-sizing: border-box;
        }
        .setting-note {
            font-size: 12px; color: #666; 
            margin-top: -10px; margin-bottom: 15px;
        }

        /* èœå• - è¯è¯­ç¼–è¾‘ */
        #phrases-input {
            width: 100%; height: 150px; box-sizing: border-box; 
            border: 1px solid #ccc; border-radius: 6px;
            padding: 10px; font-size: 14px; line-height: 1.5;
            resize: vertical; 
        }

        /* èœå• - æŒ‰é’® */
        #save-button {
            width: 100%; padding: 12px; font-size: 16px;
            background-color: #007bff; color: white;
            border: none; border-radius: 6px;
            cursor: pointer; margin-top: 15px;
        }

        /* --- ğŸŸ¢ æ–°å¢ï¼šå“åº”å¼é€‚é… (ç§»åŠ¨ç«¯) --- */
        @media (max-width: 600px) {
            .controls {
                padding: 10px; /* ç¼©å°åœ¨ç§»åŠ¨ç«¯çš„å†…è¾¹è· */
            }

            .menu-panel {
                width: auto; /* è‡ªåŠ¨å®½åº¦ */
                left: 15px;  /* å·¦å³è¾¹è· */
                right: 15px;
                top: 60px; /* ç¦»é¡¶éƒ¨è¿‘ä¸€ç‚¹ */
                padding: 0 15px 15px 15px; /* è°ƒæ•´å†…è¾¹è· */
                max-height: calc(100vh - 80px); /* è°ƒæ•´æœ€å¤§é«˜åº¦ */
            }

            .menu-section h3 {
                font-size: 1.1em;
            }

            .control-button {
                padding: 8px 14px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>

    <div class="controls">
        <button id="pause-button" class="control-button">æš‚åœ</button>
        <button id="menu-button" class="control-button">èœå•</button>
    </div>

    <div id="menu-panel" class="menu-panel">
        
        <div class="menu-section">
            <h3>ğŸ¨ åˆ‡æ¢ä¸»é¢˜</h3>
            <div class="theme-selector">
                <button class="theme-button" data-theme="default">é»˜è®¤</button>
                <button class="theme-button" data-theme="warm">æ¸©æš–</button>
                <button class="theme-button" data-theme="cool">æ¸…å‡‰</button>
                <button class="theme-button" data-theme="dark">æ·±è‰²</button>
                <button class="theme-button" data-theme="green">ç»¿è‰²</button>
            </div>
        </div>

        <div class="menu-section">
            <h3>âš™ï¸ æ•ˆæœè®¾ç½®</h3>
            <div class="setting-item">
                <label for="speed-input">ç”Ÿæˆé€Ÿåº¦ (æ¯«ç§’)</label>
                <input type="number" id="speed-input" min="100" step="100">
            </div>
            <p class="setting-note">(å»ºè®® 100-2000 ä¹‹é—´ï¼Œè¶Šå°è¶Šå¿«)</p>
            <div class="setting-item">
                <label for="duration-input">æ¶ˆå¤±æ—¶é—´ (æ¯«ç§’)</label>
                <input type="number" id="duration-input" min="1000" step="500">
            </div>
            <p class="setting-note">(å»ºè®® 2000-8000 ä¹‹é—´ï¼Œè¶Šé•¿åœç•™è¶Šä¹…)</p>
        </div>

        <div class="menu-section">
            <h3>âœï¸ ç¼–è¾‘æ¸©é¦¨è¯è¯­</h3>
            <p style="font-size: 12px; color: #666; margin-top: 0;">(æ¯è¡Œä¸€å¥)</p>
            <textarea id="phrases-input"></textarea>
        </div>

        <div id="image-settings" class="menu-section hidden">
            <h3>ğŸ–¼ï¸ å›¾ç‰‡è®¾ç½® <span style="font-size: 12px; color: #007bff;">(å·²è§£é”)</span></h3>
            
            <input type="file" id="image-upload" multiple accept="image/*" style="width: 100%; margin-bottom: 10px;">
            <p id="image-status" style="font-size: 14px; color: #333; margin: 5px 0 10px;">å·²åŠ è½½ 0 / 50 å¼ å›¾ç‰‡</p>
            <p class="setting-note" style="margin-top: 0; color: #d9534f;">(æ³¨æ„ï¼šå›¾ç‰‡ä»…åœ¨å½“å‰ä¼šè¯æœ‰æ•ˆï¼Œå…³é—­é¡µé¢å°†ä¸¢å¤±)</p>

            <div class="setting-item">
                <label for="border-size-input">è¾¹æ¡†å¤§å° (px)</label>
                <input type="number" id="border-size-input" min="0" max="20" step="1" value="3">
            </div>
             <div class="setting-item">
                <label for="border-style-input">è¾¹æ¡†æ ·å¼</label>
                <select id="border-style-input">
                    <option value="solid">å®çº¿</option>
                    <option value="dashed">è™šçº¿</option>
                    <option value="double">åŒå®çº¿</option>
                    <option value="dotted">ç‚¹çº¿</option>
                </select>
            </div>
        </div>
        
        <button id="save-button">ä¿å­˜å¹¶å…³é—­</button>
    </div>

    <script>
        // --- çŠ¶æ€å˜é‡ ---
        let isPaused = false;
        let messageInterval;
        let messages = [
            "ä½ å¥½å‘€ï¼", "ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒå“¦ï¼", "ä½ æ˜¯æœ€æ£’çš„ï¼",
            "åŠ æ²¹ï¼", "ä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„", "ä¸–ç•Œå› ä¸ºä½ è€Œç¾å¥½",
            "åˆ«å¿˜äº†ä¼‘æ¯", "ä¿æŒå¾®ç¬‘ :)"
        ];
        let messageSpawnRate = 700;
        let messageDuration = 3900;
        
        // --- å›¾ç‰‡åŠŸèƒ½å˜é‡ ---
        let userImages = [];
        const MAX_IMAGES = 50;
        let imageFeatureUnlocked = false;
        const unlockedThemes = new Set();
        let imageBorderSize = 3;
        let imageBorderStyle = 'solid';
        let imageSpawnChance = 0.3;

        // --- DOM å…ƒç´  (å·²ä¿®æ”¹) ---
        const controlsContainer = document.querySelector('.controls');
        const pauseButton = document.getElementById('pause-button');
        const menuButton = document.getElementById('menu-button');
        const menuPanel = document.getElementById('menu-panel');
        const phrasesInput = document.getElementById('phrases-input');
        const saveButton = document.getElementById('save-button');
        const themeSelector = document.querySelector('.theme-selector');
        const speedInput = document.getElementById('speed-input');
        const durationInput = document.getElementById('duration-input');
        
        // --- å›¾ç‰‡åŠŸèƒ½ DOM å…ƒç´  ---
        const imageSettingsSection = document.getElementById('image-settings');
        const imageUpload = document.getElementById('image-upload');
        const imageStatus = document.getElementById('image-status');
        const borderSizeInput = document.getElementById('border-size-input');
        const borderStyleInput = document.getElementById('border-style-input');
        
        /**
         * ç”Ÿæˆå…ƒç´ çš„æ€»æ§å‡½æ•°
         */
        function spawnElement() {
            if (isPaused) { return; }
            const shouldSpawnImage = userImages.length > 0 && Math.random() < imageSpawnChance;
            if (shouldSpawnImage) {
                createImageCard();
            } else {
                createMessageCard();
            }
        }

        /**
         * åˆ›å»ºä¸€ä¸ªè¯è¯­å¡ç‰‡
         */
        function createMessageCard() {
            const card = document.createElement('div');
            card.className = 'floating-card message-card';
            const text = messages[Math.floor(Math.random() * messages.length)];
            card.textContent = text;
            setupCardPositionAndAnimation(card);
        }
        
        /**
         * åˆ›å»ºä¸€ä¸ªå›¾ç‰‡å¡ç‰‡
         */
        function createImageCard() {
            const card = document.createElement('div');
            card.className = 'floating-card image-card';
            const img = document.createElement('img');
            img.src = userImages[Math.floor(Math.random() * userImages.length)];
            card.appendChild(img);
            card.style.borderWidth = `${imageBorderSize}px`;
            card.style.borderStyle = imageBorderStyle;
            setupCardPositionAndAnimation(card);
        }
        
        /**
         * ğŸŸ¢ è®¾ç½®å¡ç‰‡ä½ç½®å’ŒåŠ¨ç”» (å·²ä¿®æ”¹ä¸ºåŠ¨æ€é€‚é…)
         */
        function setupCardPositionAndAnimation(cardElement) {
            // 1. å…ˆæ·»åŠ åˆ° DOM æ‰èƒ½è·å–å°ºå¯¸
            document.body.appendChild(cardElement); 
            
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // 2. è·å–å¡ç‰‡è‡ªèº«çš„å®é™…å°ºå¯¸
            const cardWidth = cardElement.offsetWidth;
            const cardHeight = cardElement.offsetHeight;
            
            // 3. æ ¹æ®å¡ç‰‡å°ºå¯¸è®¡ç®—éšæœºä½ç½®
            //    å¢åŠ  10px çš„è¾¹è·ï¼Œé˜²æ­¢è´´è¾¹
            const margin = 10;
            // ç¡®ä¿æœ€å¤§ X/Y ä¸ä¼šå°äºè¾¹è·
            const maxX = Math.max(margin, viewportWidth - cardWidth - margin);
            const maxY = Math.max(margin, viewportHeight - cardHeight - margin);
            
            // ç¡®ä¿ X/Y åæ ‡åœ¨ [margin, maxX] å’Œ [margin, maxY] ä¹‹é—´
            const x = (Math.random() * (maxX - margin)) + margin;
            const y = (Math.random() * (maxY - margin)) + margin;

            // 4. åº”ç”¨ä½ç½®å’ŒåŠ¨ç”»
            cardElement.style.left = `${x}px`;
            cardElement.style.top = `${y}px`;
            cardElement.style.animationDuration = `${messageDuration / 1000}s`;
            
            setTimeout(() => {
                if (cardElement) {
                    cardElement.remove();
                }
            }, messageDuration);
        }

        /**
         * å¯åŠ¨/åœæ­¢è¯è¯­ç”Ÿæˆ
         */
        function startSpawning() {
            stopSpawning(); 
            if (!messageInterval) {
                messageInterval = setInterval(spawnElement, messageSpawnRate);
            }
        }
        function stopSpawning() {
            clearInterval(messageInterval);
            messageInterval = null;
        }

        /**
         * æš‚åœ/å¼€å¯ æŒ‰é’®äº‹ä»¶
         */
        pauseButton.addEventListener('click', () => {
            isPaused = !isPaused;
            if (isPaused) {
                pauseButton.textContent = 'å¼€å¯';
                stopSpawning();
            } else {
                pauseButton.textContent = 'æš‚åœ';
                startSpawning();
            }
        });

        /**
         * èœå• æŒ‰é’®äº‹ä»¶
         */
        menuButton.addEventListener('click', () => {
            const isVisible = menuPanel.classList.toggle('visible');
            controlsContainer.classList.toggle('force-visible', isVisible);
            if (isVisible) {
                phrasesInput.value = messages.join('\n');
                speedInput.value = messageSpawnRate;
                durationInput.value = messageDuration;
                if (imageFeatureUnlocked) {
                    borderSizeInput.value = imageBorderSize;
                    borderStyleInput.value = imageBorderStyle;
                }
            }
        });

        /**
         * ä¿å­˜ æŒ‰é’®äº‹ä»¶
         */
        saveButton.addEventListener('click', () => {
            const newText = phrasesInput.value;
            const newMessages = newText.split('\n')
                                     .map(line => line.trim()) 
                                     .filter(line => line.length > 0); 
            if (newMessages.length > 0) { messages = newMessages; }
            const newSpeed = parseInt(speedInput.value, 10);
            const newDuration = parseInt(durationInput.value, 10);
            if (newSpeed && newSpeed >= 100) { messageSpawnRate = newSpeed; }
            if (newDuration && newDuration >= 1000) { messageDuration = newDuration; }
            if (imageFeatureUnlocked) {
                imageBorderSize = parseInt(borderSizeInput.value, 10) || 3;
                imageBorderStyle = borderStyleInput.value || 'solid';
            }
            stopSpawning();
            if (!isPaused) { startSpawning(); }
            menuPanel.classList.remove('visible');
            controlsContainer.classList.remove('force-visible');
            alert('è®¾ç½®å·²ä¿å­˜ï¼');
        });

        /**
         * è§£é”å›¾ç‰‡åŠŸèƒ½ (å·²ä¿®æ”¹)
         */
        function unlockImageFeature() {
            if (imageFeatureUnlocked) return;
            imageFeatureUnlocked = true;
            imageSettingsSection.classList.remove('hidden'); // åªéœ€æ˜¾ç¤ºåŠŸèƒ½åŒº
            
            borderSizeInput.value = imageBorderSize;
            borderStyleInput.value = imageBorderStyle;
            alert('ğŸ‰ éšè—åŠŸèƒ½è§£é”ï¼æ‚¨ç°åœ¨å¯ä»¥æ·»åŠ å›¾ç‰‡äº†ï¼');
        }

        /**
         * å¤„ç†å›¾ç‰‡ä¸Šä¼ 
         */
        function handleImageUpload(event) {
            const files = event.target.files;
            if (!files) return;
            for (let i = 0; i < files.length; i++) {
                if (userImages.length >= MAX_IMAGES) {
                    alert(`æœ€å¤šåªèƒ½æ·»åŠ  ${MAX_IMAGES} å¼ å›¾ç‰‡ã€‚`);
                    break;
                }
                const file = files[i];
                if (!file.type.startsWith('image/')){ continue; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (userImages.length < MAX_IMAGES) {
                        userImages.push(e.target.result);
                    }
                    updateImageStatus();
                }
                reader.readAsDataURL(file);
            }
            event.target.value = null; 
        }

        function updateImageStatus() {
            imageStatus.textContent = `å·²åŠ è½½ ${userImages.length} / ${MAX_IMAGES} å¼ å›¾ç‰‡`;
        }

        // --- äº‹ä»¶ç›‘å¬ ---

        /**
         * ä¸»é¢˜åˆ‡æ¢ äº‹ä»¶ (å½©è›‹é€»è¾‘)
         */
        themeSelector.addEventListener('click', (event) => {
            const target = event.target;
            if (target.classList.contains('theme-button')) {
                const theme = target.dataset.theme;
                
                // 1. åº”ç”¨ä¸»é¢˜
                document.body.className = document.body.className.replace(/\btheme-[^\s]*/g, '');
                if (theme !== 'default') {
                    document.body.classList.add(`theme-${theme}`);
                }
                
                // 2. å½©è›‹é€»è¾‘
                if (!imageFeatureUnlocked) {
                    target.classList.add('clicked');
                    unlockedThemes.add(theme);
                    if (unlockedThemes.size === 5) { // 5ä¸ªä¸»é¢˜
                        unlockImageFeature();
                    }
                }
            }
        });
        
        // ç›‘å¬å›¾ç‰‡ä¸Šä¼ 
        imageUpload.addEventListener('change', handleImageUpload);

        /**
         * å¯åŠ¨
         */
        document.addEventListener('DOMContentLoaded', () => {
            startSpawning();
        });
    </script>
</body>
</html>
